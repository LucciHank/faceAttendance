<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Face Recognition</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        text-align: center;
      }
      img {
        border: 2px solid #000;
        margin-bottom: 10px;
      }
      #label {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 10px;
      }
      #status {
        min-height: 30px; /* ƒê·∫∑t chi·ªÅu cao t·ªëi thi·ªÉu ƒë·ªÉ kh√¥ng b·ªã nh·∫£y */
        line-height: 30px; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
        font-size: 16px;
        font-weight: bold;
        text-align: center;
        color: #ff9800; /* M√†u cam ƒë·ªÉ n·ªïi b·∫≠t */
        background-color: #fff3cd; /* N·ªÅn v√†ng nh·∫°t ƒë·ªÉ thu h√∫t ch√∫ √Ω */
        border: 1px solid #ffcc00; /* Vi·ªÅn ƒë·ªÉ ph√¢n bi·ªát */
        border-radius: 5px;
        padding: 5px 10px;
        margin: 10px 0;
        visibility: hidden; /* M·∫∑c ƒë·ªãnh ·∫©n nh∆∞ng v·∫´n gi·ªØ ch·ªó */
      }

      #status.active {
        visibility: visible; /* Khi c√≥ n·ªôi dung th√¨ hi·ªÉn th·ªã */
      }

      .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border: 1px solid black;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
      }
      .modal-content {
        margin-bottom: 10px;
      }
      .close {
        cursor: pointer;
        color: red;
      }
    </style>
  </head>
  <body>
    <h1>Face Recognition with Flask</h1>
    <img
      id="video"
      src="{{ url_for('video_feed') }}"
      width="640"
      height="480"
    />
    <div id="label">Label:</div>
    <div id="status"></div>
    <div id="modal" class="modal">
      <div id="modal-content" class="modal-content"></div>
      <p id="countdown"></p>
      <button class="close" onclick="closeModal()">Close</button>
    </div>

    <script>
      let lastLabel = "";
      let unchangedTime = 0;
      let locked = false;
      let checking = false;
      let verifyTimeout = null;
      let source = new EventSource("/get_label");

      function startEventSource() {
        if (source) {
          source.close(); // ƒê·∫£m b·∫£o kh√¥ng c√≥ instance n√†o tr∆∞·ªõc khi m·ªü l·∫°i
        }
        source = new EventSource("/get_label");
        source.onmessage = handleLabel;
      }

      function handleLabel(event) {
        if (locked) return;

        const newLabel = event.data;
        document.getElementById("label").textContent = "Label: " + newLabel;
        const statusElement = document.getElementById("status");

        if (newLabel && newLabel === lastLabel) {
          unchangedTime += 1000;
        } else {
          unchangedTime = 0;
          statusElement.textContent = "";
          statusElement.classList.remove("active");
          checking = false;

          // H·ªßy x√°c minh n·∫øu nh√£n thay ƒë·ªïi
          if (verifyTimeout) {
            clearTimeout(verifyTimeout);
            verifyTimeout = null;
          }
        }
        lastLabel = newLabel;

        if (unchangedTime >= 5000 && !checking) {
          checking = true;
          statusElement.textContent = `ƒêang x√°c minh nh√¢n vi√™n m√£ ${newLabel}`;
          statusElement.classList.add("active");
          // ƒê·∫∑t b·ªô ƒë·∫øm th·ªùi gian v√† l∆∞u ID v√†o `verifyTimeout`
          verifyTimeout = setTimeout(() => {
            if (checking && lastLabel === newLabel) {
              locked = true;
              source.close(); // Ch·ªâ t·∫Øt ngu·ªìn s·ª± ki·ªán, kh√¥ng ·∫£nh h∆∞·ªüng video
              checkIn(newLabel);
            } else {
              checking = false;
              statusElement.textContent = "";
              statusElement.classList.remove("active");
            }
            verifyTimeout = null; // Reset bi·∫øn sau khi ki·ªÉm tra xong
          }, 3000);
        }
      }

      source.onmessage = handleLabel;

      function checkIn(employeeId) {
        let formData = new FormData();
        formData.append("employee_id", employeeId);

        fetch("/api/checkin", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            showModal(data);
          })
          .catch((error) => {
            console.error("Error:", error);
            resetState(); // ƒê·∫£m b·∫£o reset l·∫°i n·∫øu c√≥ l·ªói
          });
      }

      function showModal(data) {
        const modal = document.getElementById("modal");
        const content = document.getElementById("modal-content");
        const countdown = document.getElementById("countdown");
        content.innerHTML = `
    <p>${data.message}</p>
    <p>ID: ${data.employee.id}</p>
    <p>Name: ${data.employee.name}</p>
    <p>Check-in: ${data.employee.check_in_time || "N/A"}</p>
    <p>Check-out: ${data.employee.check_out_time || "N/A"}</p>
  `;
        modal.style.display = "block";
        let timeLeft = 5;
        countdown.textContent = `Closing in ${timeLeft}s`;
        const interval = setInterval(() => {
          countdown.textContent = `Closing in ${--timeLeft}s`;
          if (timeLeft === 0) {
            clearInterval(interval);
            closeModal();
          }
        }, 1000);
      }

      function closeModal() {
        document.getElementById("modal").style.display = "none";
        resetState(); // G·ªçi reset l·∫°i tr·∫°ng th√°i sau khi ƒë√≥ng modal
      }

      // üõ†Ô∏è Reset l·∫°i tr·∫°ng th√°i ƒë·ªÉ h·ªá th·ªëng ti·∫øp t·ª•c x√°c minh nh√¢n vi√™n m·ªõi
      function resetState() {
        locked = false;
        checking = false;
        unchangedTime = 0;
        lastLabel = "";
        startEventSource(); // M·ªü l·∫°i EventSource ƒë·ªÉ ti·∫øp t·ª•c nh·∫≠n d·ªØ li·ªáu
      }
    </script>
  </body>
</html>
